name: CI/CD Pipeline

on:
  push:
    branches: [ master, main, develop ]
  pull_request:
    branches: [ master, main, develop ]
  workflow_dispatch:

env:
  CFLAGS: "-fcommon"

jobs:
  # ===========================================================================
  # Build and Test - Ubuntu
  # ===========================================================================
  build-ubuntu:
    name: Build & Test (Ubuntu ${{ matrix.ubuntu-version }})
    runs-on: ubuntu-${{ matrix.ubuntu-version }}
    strategy:
      fail-fast: false
      matrix:
        ubuntu-version: [22.04, 24.04]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          autoconf \
          automake \
          libtool \
          pkg-config \
          libssl-dev \
          libev-dev \
          zlib1g-dev \
          valgrind \
          cppcheck \
          flawfinder \
          clang \
          clang-tools \
          lcov

    - name: Generate build system
      run: ./autogen.sh

    - name: Configure
      run: ./configure

    - name: Build
      run: make -j$(nproc)

    - name: Run unit tests
      run: ./tests-unit

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: binaries-ubuntu-${{ matrix.ubuntu-version }}
        path: |
          websocket-client
          websocket-testsuite
          stomp-client
          tests-unit
          libwsclient.a
        retention-days: 7

  # ===========================================================================
  # Build and Test - macOS
  # ===========================================================================
  build-macos:
    name: Build & Test (macOS ${{ matrix.macos-version }})
    runs-on: macos-${{ matrix.macos-version }}
    strategy:
      fail-fast: false
      matrix:
        macos-version: [13, 14]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Install dependencies
      run: |
        brew update || true
        brew install \
          autoconf \
          automake \
          libtool \
          pkg-config \
          openssl@3 \
          libev \
          zlib \
          cppcheck \
          flawfinder \
          lcov

    - name: Generate build system
      run: ./autogen.sh

    - name: Configure
      run: |
        export PKG_CONFIG_PATH="/usr/local/opt/openssl@3/lib/pkgconfig:$PKG_CONFIG_PATH"
        ./configure

    - name: Build
      run: make -j$(sysctl -n hw.ncpu)

    - name: Run unit tests
      run: ./tests-unit

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: binaries-macos-${{ matrix.macos-version }}
        path: |
          websocket-client
          websocket-testsuite
          stomp-client
          tests-unit
          libwsclient.a
        retention-days: 7

  # ===========================================================================
  # Integration Tests with Docker
  # ===========================================================================
  integration-tests:
    name: Integration Tests (Autobahn)
    runs-on: ubuntu-latest
    needs: [build-ubuntu]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Run Autobahn integration tests
      run: |
        make integration-test
      timeout-minutes: 30

    - name: Upload Autobahn reports
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: autobahn-reports
        path: autobahn-reports/
        retention-days: 30

    - name: Check Autobahn test results
      run: |
        if [ -f autobahn-reports/clients/index.json ]; then
          echo "Autobahn test results:"
          python3 -c "
          import json
          import sys
          with open('autobahn-reports/clients/index.json') as f:
              data = json.load(f)
              for client, results in data.items():
                  total = len(results)
                  passed = sum(1 for r in results.values() if r.get('behavior') == 'OK')
                  print(f'{client}: {passed}/{total} tests passed')
                  if passed < total:
                      sys.exit(1)
          "
        else
          echo "No Autobahn results found"
          exit 1
        fi

  # ===========================================================================
  # STOMP Integration Tests
  # ===========================================================================
  stomp-tests:
    name: STOMP Integration Tests
    runs-on: ubuntu-latest
    needs: [build-ubuntu]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          autoconf \
          automake \
          libtool \
          pkg-config \
          libssl-dev \
          libev-dev \
          zlib1g-dev

    - name: Generate build system
      run: ./autogen.sh

    - name: Configure
      run: ./configure

    - name: Build
      run: make -j$(nproc)

    - name: Run STOMP tests
      run: make stomp-test
      timeout-minutes: 10

  # ===========================================================================
  # Valgrind Memory Tests
  # ===========================================================================
  memory-tests:
    name: Memory Tests (Valgrind)
    runs-on: ubuntu-latest
    needs: [build-ubuntu]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          autoconf \
          automake \
          libtool \
          pkg-config \
          libssl-dev \
          libev-dev \
          zlib1g-dev \
          valgrind

    - name: Generate build system
      run: ./autogen.sh

    - name: Configure
      run: ./configure

    - name: Build
      run: make -j$(nproc)

    - name: Run Valgrind memory check
      run: |
        valgrind \
          --leak-check=full \
          --show-leak-kinds=definite \
          --errors-for-leak-kinds=definite \
          --track-origins=yes \
          --error-exitcode=1 \
          ./tests-unit

    - name: Run Valgrind memcheck
      run: |
        valgrind \
          --tool=memcheck \
          --leak-check=full \
          --show-reachable=yes \
          --track-origins=yes \
          --log-file=memcheck-report.txt \
          --error-exitcode=1 \
          ./tests-unit

    - name: Upload Valgrind reports
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: valgrind-reports
        path: |
          memcheck-report.txt
        retention-days: 30

  # ===========================================================================
  # Static Analysis
  # ===========================================================================
  static-analysis:
    name: Static Analysis
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          autoconf \
          automake \
          libtool \
          pkg-config \
          libssl-dev \
          libev-dev \
          zlib1g-dev \
          cppcheck \
          clang \
          clang-tools

    - name: Generate build system
      run: ./autogen.sh

    - name: Configure
      run: ./configure

    - name: Build
      run: make -j$(nproc)

    - name: Run cppcheck
      run: |
        cppcheck \
          --enable=all \
          --inconclusive \
          --std=c99 \
          --suppress=missingIncludeSystem \
          --template=gcc \
          -I src/cwebsocket \
          src/cwebsocket/*.c src/*.c \
          2>&1 | tee cppcheck-report.txt

    - name: Run clang-tidy
      run: |
        clang-tidy \
          src/cwebsocket/*.c \
          -- \
          -I src/cwebsocket \
          -I . \
          2>&1 | tee clang-tidy-report.txt || true

    - name: Upload static analysis reports
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: static-analysis-reports
        path: |
          cppcheck-report.txt
          clang-tidy-report.txt
        retention-days: 30

  # ===========================================================================
  # Security Scanning
  # ===========================================================================
  security-scan:
    name: Security Scanning
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          flawfinder \
          cppcheck

    - name: Run Flawfinder
      run: |
        flawfinder \
          --quiet \
          --dataonly \
          --minlevel=1 \
          src/cwebsocket/*.c src/*.c \
          2>&1 | tee flawfinder-report.txt

    - name: Run security-focused cppcheck
      run: |
        cppcheck \
          --enable=warning \
          --std=c99 \
          --suppress=missingIncludeSystem \
          -I src/cwebsocket \
          src/cwebsocket/*.c src/*.c \
          2>&1 | tee cppcheck-security-report.txt

    - name: Upload security reports
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: security-reports
        path: |
          flawfinder-report.txt
          cppcheck-security-report.txt
        retention-days: 30

  # ===========================================================================
  # Code Coverage
  # ===========================================================================
  coverage:
    name: Code Coverage
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          autoconf \
          automake \
          libtool \
          pkg-config \
          libssl-dev \
          libev-dev \
          zlib1g-dev \
          lcov

    - name: Generate build system
      run: ./autogen.sh

    - name: Configure with coverage flags
      run: |
        ./configure CFLAGS="-fprofile-arcs -ftest-coverage -O0 -g"

    - name: Build
      run: make -j$(nproc)

    - name: Run tests
      run: ./tests-unit

    - name: Generate coverage report
      run: |
        lcov --capture --directory . --output-file coverage.info
        lcov --remove coverage.info '/usr/*' '*/test/*' --output-file coverage.info
        lcov --list coverage.info

    - name: Generate HTML coverage report
      run: |
        genhtml coverage.info --output-directory coverage-html

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v4
      with:
        files: ./coverage.info
        fail_ci_if_error: false
        verbose: true
      env:
        CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

    - name: Upload coverage report
      uses: actions/upload-artifact@v4
      with:
        name: coverage-report
        path: |
          coverage.info
          coverage-html/
        retention-days: 30

    - name: Check coverage threshold
      run: |
        coverage_percent=$(lcov --summary coverage.info 2>&1 | grep "lines" | awk '{print $2}' | sed 's/%//')
        echo "Coverage: ${coverage_percent}%"
        if (( $(echo "$coverage_percent < 70" | bc -l) )); then
          echo "Warning: Coverage is below 70%"
          # Don't fail the build, just warn
        fi

  # ===========================================================================
  # Build Status Summary
  # ===========================================================================
  build-status:
    name: Build Status Summary
    runs-on: ubuntu-latest
    needs: [build-ubuntu, build-macos, integration-tests, stomp-tests, memory-tests, static-analysis, security-scan, coverage]
    if: always()

    steps:
    - name: Check build status
      run: |
        echo "Build Status Summary:"
        echo "===================="
        echo "Ubuntu Build: ${{ needs.build-ubuntu.result }}"
        echo "macOS Build: ${{ needs.build-macos.result }}"
        echo "Integration Tests: ${{ needs.integration-tests.result }}"
        echo "STOMP Tests: ${{ needs.stomp-tests.result }}"
        echo "Memory Tests: ${{ needs.memory-tests.result }}"
        echo "Static Analysis: ${{ needs.static-analysis.result }}"
        echo "Security Scan: ${{ needs.security-scan.result }}"
        echo "Coverage: ${{ needs.coverage.result }}"

        if [[ "${{ needs.build-ubuntu.result }}" != "success" ]] || \
           [[ "${{ needs.build-macos.result }}" != "success" ]] || \
           [[ "${{ needs.integration-tests.result }}" != "success" ]] || \
           [[ "${{ needs.memory-tests.result }}" != "success" ]]; then
          echo "Build failed!"
          exit 1
        fi

        echo "Build successful!"
